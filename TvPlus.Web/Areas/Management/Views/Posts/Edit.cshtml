@using TvPlus.Infrastructure.ViewModels
@model TvPlus.Infrastructure.ViewModels.EditPostViewModel
@{
    ViewData["Title"] = "ویرایش پست";
}
@section Header {
    <link href="~/management/css/pages/wizard/wizard-1.css" rel="stylesheet" />
    <link href="~/videojs/video-js.css" rel="stylesheet" />
}
<div class="col-lg-12">
    <div class="card card-custom gutter-b">
        <div class="card-header">
            <h3 class="card-title">
                @ViewData["Title"]
            </h3>
            <div style="display: flex;align-items:center">
                <a href="@Url.Action("Index")" class="btn btn-danger">انصراف</a>
            </div>
        </div>
        <div class="card-body p-0">
            <!--begin::Entry-->
            <div class="wizard wizard-1" id="kt_projects_add" data-wizard-state="step-first" data-wizard-clickable="true">
                <div class="kt-grid__item">
                    <!--begin::Wizard Nav-->
                    <div class="wizard-nav">
                        <div class="wizard-steps p-8 p-lg-10">
                            <div class="wizard-step" data-wizard-type="step" data-wizard-state="current">
                                <div class="wizard-label">
                                    <span class="svg-icon svg-icon-4x wizard-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                <rect x="0" y="0" width="24" height="24" />
                                                <path d="M4.875,20.75 C4.63541667,20.75 4.39583333,20.6541667 4.20416667,20.4625 L2.2875,18.5458333 C1.90416667,18.1625 1.90416667,17.5875 2.2875,17.2041667 C2.67083333,16.8208333 3.29375,16.8208333 3.62916667,17.2041667 L4.875,18.45 L8.0375,15.2875 C8.42083333,14.9041667 8.99583333,14.9041667 9.37916667,15.2875 C9.7625,15.6708333 9.7625,16.2458333 9.37916667,16.6291667 L5.54583333,20.4625 C5.35416667,20.6541667 5.11458333,20.75 4.875,20.75 Z" fill="#000000" fill-rule="nonzero" opacity="0.3" />
                                                <path d="M2,11.8650466 L2,6 C2,4.34314575 3.34314575,3 5,3 L19,3 C20.6568542,3 22,4.34314575 22,6 L22,15 C22,15.0032706 21.9999948,15.0065399 21.9999843,15.009808 L22.0249378,15 L22.0249378,19.5857864 C22.0249378,20.1380712 21.5772226,20.5857864 21.0249378,20.5857864 C20.7597213,20.5857864 20.5053674,20.4804296 20.317831,20.2928932 L18.0249378,18 L12.9835977,18 C12.7263047,14.0909841 9.47412135,11 5.5,11 C4.23590829,11 3.04485894,11.3127315 2,11.8650466 Z M6,7 C5.44771525,7 5,7.44771525 5,8 C5,8.55228475 5.44771525,9 6,9 L15,9 C15.5522847,9 16,8.55228475 16,8 C16,7.44771525 15.5522847,7 15,7 L6,7 Z" fill="#000000" />
                                            </g>
                                        </svg><!--end::Svg Icon-->
                                    </span>
                                    <h3 class="wizard-title">جزییات پست</h3>
                                </div>
                                <span class="svg-icon svg-icon-xl wizard-arrow">

                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <polygon points="0 0 24 0 24 24 0 24" />
                                            <rect fill="#000000" opacity="0.3" transform="translate(12.000000, 12.000000) scale(-1, 1) rotate(-90.000000) translate(-12.000000, -12.000000) " x="11" y="5" width="2" height="14" rx="1" />
                                            <path d="M3.7071045,15.7071045 C3.3165802,16.0976288 2.68341522,16.0976288 2.29289093,15.7071045 C1.90236664,15.3165802 1.90236664,14.6834152 2.29289093,14.2928909 L8.29289093,8.29289093 C8.67146987,7.914312 9.28105631,7.90106637 9.67572234,8.26284357 L15.6757223,13.7628436 C16.0828413,14.136036 16.1103443,14.7686034 15.7371519,15.1757223 C15.3639594,15.5828413 14.7313921,15.6103443 14.3242731,15.2371519 L9.03007346,10.3841355 L3.7071045,15.7071045 Z" fill="#000000" fill-rule="nonzero" transform="translate(9.000001, 11.999997) scale(-1, -1) rotate(90.000000) translate(-9.000001, -11.999997) " />
                                        </g>
                                    </svg><!--end::Svg Icon-->
                                </span>
                            </div>
                            <div class="wizard-step" data-wizard-type="step">
                                <div class="wizard-label">
                                    <span class="svg-icon svg-icon-4x wizard-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                <rect x="0" y="0" width="24" height="24" />
                                                <path d="M2,13 C2,12.5 2.5,12 3,12 C3.5,12 4,12.5 4,13 C4,13.3333333 4,15 4,18 C4,19.1045695 4.8954305,20 6,20 L18,20 C19.1045695,20 20,19.1045695 20,18 L20,13 C20,12.4477153 20.4477153,12 21,12 C21.5522847,12 22,12.4477153 22,13 L22,18 C22,20.209139 20.209139,22 18,22 L6,22 C3.790861,22 2,20.209139 2,18 C2,15 2,13.3333333 2,13 Z" fill="#000000" fill-rule="nonzero" opacity="0.3" />
                                                <rect fill="#000000" opacity="0.3" x="11" y="2" width="2" height="14" rx="1" />
                                                <path d="M12.0362375,3.37797611 L7.70710678,7.70710678 C7.31658249,8.09763107 6.68341751,8.09763107 6.29289322,7.70710678 C5.90236893,7.31658249 5.90236893,6.68341751 6.29289322,6.29289322 L11.2928932,1.29289322 C11.6689749,0.916811528 12.2736364,0.900910387 12.6689647,1.25670585 L17.6689647,5.75670585 C18.0794748,6.12616487 18.1127532,6.75845471 17.7432941,7.16896473 C17.3738351,7.57947475 16.7415453,7.61275317 16.3310353,7.24329415 L12.0362375,3.37797611 Z" fill="#000000" fill-rule="nonzero" />
                                            </g>
                                        </svg>
                                    </span>
                                    <h3 class="wizard-title">آپلود ویدیو</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Wizard Nav-->
                </div>
                <div class="row justify-content-center my-10 px-8 my-lg-15 px-lg-10">
                    <div class="col-xl-12 col-xxl-10">
                        <!--begin::Form Wizard-->
                        <form class="form" id="form" enctype="multipart/form-data">
                            <!--begin::Step 1-->
                            <div class="pb-5" data-wizard-type="step-content" data-wizard-state="current">
                                <h3 class="text-dark mb-10">جزئیات پست:</h3>
                                <div class="row">
                                    <div class="col-xl-10">
                                        <input type="hidden" asp-for="Id" />
                                        <input type="hidden" asp-for="EditMode" value="@(EditMode.Edit)" />
                                        <div class="form-group row">
                                            <label class="col-xl-2 col-lg-2 col-form-label">عنوان کوتاه</label>
                                            <div class="col-lg-10 col-xl-10">
                                                <input class="form-control" asp-for="ShortTitle" type="text" placeholder="عنوان کوتاه پست را وارد کنید" />
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-xl-2 col-lg-2 col-form-label">عنوان</label>
                                            <div class="col-lg-10 col-xl-10">
                                                <input class="form-control" asp-for="Title"  placeholder="عنوان پست را وارد کنید"/>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-xl-2 col-lg-2 col-form-label">دسته بندی</label>
                                            <div class="col-lg-10 col-xl-10">
                                                <select class="form-control form-control-xl select2" id="categories" name="param" multiple>
                                                    @foreach (var item in ViewBag.Categories)
                                                    {
                                                        <option value="@item.Id" selected="@item.Selected">@item.Title</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-xl-2 col-lg-2 col-form-label">توضیحات</label>
                                            <div class="col-lg-10 col-xl-10">
                                                <textarea class="form-control ckEditor" asp-for="Description">@Html.Raw(Model.Description)</textarea>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-xl-2 col-lg-2 col-form-label">افراد مرتبط</label>
                                            <div class="col-lg-10 col-xl-10">
                                                <input id="people" class="form-control form-control-lg tagify" placeholder='' value='@Model.People' />
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-xl-2 col-lg-2 col-form-label">برچسب ها</label>
                                            <div class="col-lg-10 col-xl-10">
                                                <input id="tags" class="form-control form-control-lg tagify" placeholder='' value='@Model.Tags' />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--end::Step 1-->
                            <!--begin::Step 2-->
                            <div class="pb-5" data-wizard-type="step-content">
                                <div class="row">
                                    <div class="col-xl-12">
                                        <div class="form-group row">
                                            <div class="col-lg-9 col-xl-6">
                                                <h3 class="text-dark mb-10">آپلود ویدیو :</h3>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-label">تصویر</label>
                                            <div class="col-lg-12 col-md-12 col-sm-12" style="margin-top:20px">
                                                <div class="image-input image-input-outline" id="post-image">
                                                    <div class="image-input-wrapper" style="background-image: url(/UploadedFiles/Images/@Model.ImageName)"></div>
                                                    <label class="btn btn-xs btn-icon btn-circle btn-white btn-hover-text-primary btn-shadow" data-action="change" data-toggle="tooltip" title="" data-original-title="آپلود تصویر">
                                                        <i class="fa fa-pen icon-sm text-muted"></i>
                                                        <input type="file" name="PostImage" id="PostImage" accept=".png, .jpg, .jpeg" />
                                                        <input type="hidden" name="post_image_remove" />
                                                    </label>

                                                    <span class="btn btn-xs btn-icon btn-circle btn-white btn-hover-text-primary btn-shadow" data-action="cancel" data-toggle="tooltip" title="حذف تصویر">
                                                        <i class="ki ki-bold-close icon-xs text-muted"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            <input type="hidden" name="ImageValidation" id="ImageValidation" value="@(Model.ImageName != null?"true":"false")" />
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xl-2 col-lg-2 col-form-label" style="margin-bottom:20px">ویدیو</label>
                                            <div class="col-lg-12 col-md-12 col-sm-12">
                                                <div class="dropzone dropzone-default" id="videoInput">
                                                    <div class="dropzone-msg dz-message needsclick">
                                                        <h3 class="dropzone-msg-title">آپلود فایل</h3>
                                                        <span class="dropzone-msg-desc">برای آپلود فایل را اینجا انداخته یا کلیک کنید</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" name="VideoValidation" id="VideoValidation" value="@(Model.VideoName != null? "true":"false")" />
                                        <div class="progress form-group" style="margin-top: 50px; display: none">
                                            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <button id="upload-btn" type="button" class="btn btn-secondary disabled">آپلود ویدیو</button>
                                        <div class="form-group" style="margin-top:50px">
                                            <label class="col-xl-2 col-lg-2 col-form-label">مشاهده</label>
                                            <div class="col-lg-12 col-md-12 col-sm-12">
                                                <video id="my-video"
                                                       class="video-js vjs-16-9 vjs-big-play-centered"
                                                       controls
                                                       preload="auto"
                                                       poster="/UploadedFiles/Images/@Model.ImageName"
                                                       data-setup="{}">
                                                    <source src="/UploadedFiles/Videos/@Model.VideoName" type="video/mp4" />
                                                    <p class="vjs-no-js">
                                                        To view this video please enable JavaScript, and consider upgrading to a
                                                        web browser that
                                                        <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                                                    </p>
                                                </video>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--end::Step 2-->
                            <!--begin::Actions-->
                            <div class="d-flex justify-content-between border-top mt-5 pt-10">
                                <div class="mr-2">
                                    <button type="button" class="btn btn-light-primary font-weight-bold text-uppercase px-9 py-4" data-wizard-type="action-prev">
                                        مرحله قبل
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-success font-weight-bold text-uppercase px-9 py-4" data-wizard-type="action-submit">
                                        ثبت
                                    </button>
                                    <button type="button" class="btn btn-primary font-weight-bold text-uppercase px-9 py-4" data-wizard-type="action-next">
                                        مرحله بعد
                                    </button>
                                </div>
                            </div>
                            <!--end::Actions-->
                        </form>
                        <!--end::Form Wizard-->
                    </div>
                </div>
            </div>
            <!--end::Entry-->
        </div>
    </div>
</div>
<style>
    .image-input .image-input-wrapper {
        width: 60vw;
        height: 35vh;
    }
</style>
@section Scripts {
    <script src="~/videojs/video.min.js"></script>
    <script src="~/ckeditor/ckeditor.js"></script>
    <script src="~/ckeditor/config.js"></script>
    <script>
        function toggleUploadBtn(command) {
            if (command == "active") {
                $("#upload-btn").removeClass("disabled");
                $("#upload-btn").removeClass("btn-secondary");
                $("#upload-btn").addClass("btn-primary");
            } else {
                $("#upload-btn").removeClass("btn-primary");
                $("#upload-btn").addClass("disabled");
                $("#upload-btn").addClass("btn-secondary");
            }
        }

        function resetProgress() {
            $(".progress").show();
            $(".progress-bar").css("width", 0 + "%").attr("aria-valuenow", 0);
            $(".progress-bar").html(0 + "%");
        }

        function updateProgressBar(progressInt) {
            $(".progress-bar").css("width", progressInt + "%").attr("aria-valuenow", progressInt);
            $(".progress-bar").html(progressInt + "%");
        }
    </script>
    <script>
        $(function () {
            $('#categories').select2({
                placeholder: "دسته بندی پست را انتخاب کنید"
            });
            new Tagify(document.getElementById('people'),
                {
                    enforceWhitelist: true,
                    whitelist: [
                        @{
                            foreach (var item in ViewBag.People)
                            {
                                <text>
                                    "@item",
                                </text>
                            }
                        }
                    ],
                    originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(',')
                });
            new Tagify(document.getElementById('tags'),
                {
                    whitelist: [
                        @{
                            foreach (var item in ViewBag.Tags)
                            {
                                <text>
                                    "@item",
                                </text>
                            }
                        }
                    ],
                    originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(',')
                });

            var image = new KTImageInput('post-image');

            image.on('cancel',
                function(imageInput) {
                    $("#ImageValidation").val(false);
                });

            image.on('change',
                function(imageInput) {
                    $("#ImageValidation").val(true);
                });

            $("#upload-btn").click(function(e) {
                e.preventDefault();
                videoDropzone.processQueue();
            });
            var videoDropzone = new Dropzone("#videoInput",
                {
                    url: "/Management/UploadVideo",
                    autoProcessQueue: false,
                    paramName: "file",
                    method: "post",
                    maxFiles: 1,
                    acceptedFiles: "video/*",
                    addRemoveLinks: true,
                    maxFilesize: 2000,
                    timeout: 10800000,
                });

            videoDropzone.on("addedfile",
                function(file) {
                    if (this.files[1] != null) {
                        this.removeFile(this.files[0]);
                    }
                    resetProgress();
                    toggleUploadBtn("active");


                });
            videoDropzone.on("removedfile",
                function(file) {
                    if (this.files[0] == null) {
                        $(".progress").hide();
                        toggleUploadBtn("deactive");
                        //$("#VideoValidation").val(false);
                    } else {
                        resetProgress();
                        toggleUploadBtn("active");
                    }
                });
            videoDropzone.on("sending",
                function (file, xhr, formData) {

                    file.xhr.upload.addEventListener("progress",
                        function(evt) {
                            if (evt.lengthComputable) {

                                var progress = Math.round((evt.loaded / evt.total) * 100);
                                $(".progress").show();
                                updateProgressBar(progress);

                            }
                        },
                        false);
                    $("#VideoValidation").val(false);
                    toggleUploadBtn("deactive");
                    formData.append("Id", $("#Id").val());
                });

            videoDropzone.on("success",
                function(progress) {
                    $("#VideoValidation").val(true);
                    resetProgress();
                    $(".progress").hide();
                    toggleUploadBtn("deactive");
                    toastr.success("ویدیو با موفقیت آپلود شد", "تایید");
                });
            videoDropzone.on("error",
                function() {
                    //$("#VideoValidation").val(false);
                    resetProgress();
                    $(".progress").hide();
                    toggleUploadBtn("deactive");
                    toastr.error("آپلود ویدیو با خطا مواجه شد", "خطا");
                });
        });
    </script>
    <script>

        var createWizard = function () {

            var _wizardEl;
            var _formEl;
            var _wizard;
            var _validations = [];

            var initWizard = function () {

                _wizard = new KTWizard(_wizardEl,
                    {
                        startStep: 1,
                        clickableSteps: true
                    });

                _wizard.on('beforeNext',
                    function (wizard) {

                        _wizard.stop();

                        var validator = _validations[wizard.getStep() - 1];
                        validator.validate().then(function (status) {
                            if (status === 'Valid') {
                                var post = createPostObj();
                                $.ajax({
                                    type: 'POST',
                                    url: "/Management/Posts/SavePost",
                                    data: post,
                                    success: function (res) {
                                        $("#Id").val(res.data);
                                        _wizard.goNext();
                                        KTUtil.scrollTop();
                                    },
                                    error: function (data) {
                                        toastr.error("ارسال جزییات با خطا مواجه شد", "خطا");
                                    }
                                });
                            } else {
                                toastr.error("لطفا ورودی های خود را بررسی کنید", "خطا");
                                KTUtil.scrollTop();
                            }
                        });
                    });

                _wizard.on('change',
                    function (wizard) {
                        KTUtil.scrollTop();
                    });
            }

            var initValidation = function () {

                _validations.push(FormValidation.formValidation(
                    _formEl,
                    {
                        fields: {
                            ShortTitle: {
                                validators: {
                                    notEmpty: {
                                        message: 'لطفا عنوان کوتاه را وارد کنید'
                                    }
                                }
                            },
                            Title: {
                                validators: {
                                    notEmpty: {
                                        message: 'لطفا عنوان را وارد کنید'
                                    }
                                }
                            },
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap: new FormValidation.plugins.Bootstrap()
                        }
                    }
                ));
            }
            return {
                init: function () {
                    _wizardEl = KTUtil.getById('kt_projects_add');
                    _formEl = KTUtil.getById('form');

                    initWizard();
                    initValidation();
                }
            };
        }();

        jQuery(document).ready(function () {
            createWizard.init();
        });
        $("#form").submit(function (e) {
            e.preventDefault();
            if ($("#VideoValidation").val() == "false" || $("#VideoValidation").val() === "") {
                toastr.error("لطفا ویدیو را آپلود کنید", "خطا");
            } else if ($("#ImageValidation").val() == "false" || $("#ImageValidation").val() === "") {
                toastr.error("لطفا تصویر را انتخاب کنید", "خطا");
            } else {
                var postId = $("#Id").val();
                var postImage = $('#PostImage').get(0).files[0];
                var formData = new FormData();
                formData.append('File', postImage);
                $.ajax({
                    type: 'POST',
                    url: "/Management/Posts/SubmitPostImage/" + postId,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        location.href = "/Management/Posts";
                    },
                    error: function (data) {
                        toastr.error("ذخیره پست با خطا مواجه شد", "خطا");
                    }
                });
            }
        });

        function createPostObj() {
            var Id = $("#Id").val();
            var ShortTitle = $("#ShortTitle").val();
            var Title = $("#Title").val();
            var Description = window.editor.getData();
            var People = $("#people").val();
            var Tags = $("#tags").val();
            var EditMode = $("#EditMode").val();
            var SelectedCategories = $("#categories").val().map(function (item) {
                return parseInt(item);
            });

            var post = {
                Id: Id,
                ShortTitle: ShortTitle,
                Title: Title,
                Description: Description,
                People: People,
                Tags: Tags,
                EditMode: EditMode,
                SelectedCategories: SelectedCategories
            }
            return post;
        };
    </script>
}